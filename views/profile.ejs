<!DOCTYPE html>
<html>

<head>
    <title>Library Management System</title>
    <link rel="stylesheet" href="stylesheet/profile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Icons">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>
                <a href="/home">LibCloud</a>
            </h2>
        </div>
        <ul class="sidebar-links">
            <h4><span>Main Menu</span></h4>
            <% if (role==='admin' ) { %>
                <li><a href="/books"><span class="material-symbols-outlined"> library_books </span>Books</a></li>
                <li><a href="/addBook"><span class="material-symbols-outlined"> auto_stories </span>Add Book</a></li>
                <li><a href="/ebooks"><span class="material-symbols-outlined"> auto_stories </span>eBooks</a></li>
                <li><a href="/addEbook"><span class="material-symbols-outlined"> person </span>Add Ebook</a></li>
                <li><a href="/users"><span class="material-symbols-outlined"> person </span>User</a></li>
                <!-- <li><a href="/Fines"><span class="material-symbols-outlined"> payments </span>Fine</a></li> -->
                <% } else { %>
                    <li><a href="/books"><span class="material-symbols-outlined"> library_books </span>Books</a></li>
                    <li><a href="/ebooks"><span class="material-symbols-outlined"> auto_stories </span>eBooks</a></li>
                    <li><a href="/fines"><span class="material-symbols-outlined"> payments </span>Fine</a></li>
                    <% } %>
                        <h4><span>Account</span></h4>
                        <li><a href="/profile"><span class="material-symbols-outlined">account_circle</span>Profile</a>
                        </li>
                        <li><a href="/logout"><span class="material-symbols-outlined"> logout </span>Logout</a></li>
        </ul>

    </aside>

    <main class="main-content">
        <div class="header">
            <!-- Profile Section -->
            <div class="center-content">
                <form action="/profile" method="POST">
                    <h2>Update Your Account</h2>

                    <div class="input-container">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" value="<%= user.email %>" class="text-input">
                    </div>

                    <div class="input-container password-container">
                        <label for="password">Password:</label>
                        <input type="password" id="password" name="password" value="<%= user.password %>"
                            class="text-input">
                        <button type="button" id="toggle-password" class="eye-button">
                            <span class="material-symbols-outlined">visibility</span>
                        </button>
                    </div>

                    <div class="button-container">
                        <button type="submit" class="confirm-save-btn"
                            onclick="updateUser()">Confirm & Save</button>
                    </div>
                </form>

                <form action="/deleteProfile" method="POST">
                    <div class="button-container">
                        <button type="submit" class="delete-account-btn" onclick="deleteUser()">Delete Account</button>
                    </div>
                </form>


            </div>
        </div>

        <script>
            document.getElementById('toggle-password').addEventListener('click', function () {
                const passwordInput = document.getElementById('password');
                const eyeIcon = this.querySelector('.material-symbols-outlined');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeIcon.textContent = 'visibility_off';
                } else {
                    passwordInput.type = 'password';
                    eyeIcon.textContent = 'visibility';
                }
            });

            function updateUser() {
                // Get the updated values from input fields
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                // Validate inputs (optional)
                if (!email && !password) {
                    alert("Please provide at least one field to update.");
                    return;
                }

                // Send POST request to the server
                fetch('/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(
                        {
                            email: email,
                            password: password,
                        }
                    ),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Profile updated successfully!");
                            // Optionally reload the page or update the UI
                            window.location.reload();
                        } else {
                            alert(data.message || "Failed to update profile.");
                        }
                    })
                    .catch(error => {
                        console.error("Error updating profile:", error);
                        alert("An error occurred. Please try again later.");
                    });
            }

            function deleteUser() {
        // Send a POST request to the server to delete the user account
        fetch('/deleteProfile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}) // You can send an empty object or user-specific data if needed
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Account deleted successfully!");
                window.location.href = '/logout'; // Redirect to logout page or any other page
            } else {
                alert(data.message || "Failed to delete account.");
            }
        })
        .catch(error => {
            console.error("Error deleting account:", error);
            alert("An error occurred. Please try again later.");
        });
    }

        </script>